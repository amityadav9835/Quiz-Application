{% extends "quiz_app/home.html" %}
{% load static %}

{% block title %}{{ quiz.title }} - Take Quiz{% endblock %}

{% block content %}

<!-- ------------------- FACE DETECTION CAMERA ------------------- -->
<div style="text-align:center; margin-bottom:20px;">
    <h4 style="color:white;">Face Detection Active</h4>

    <video id="webcam" width="260" height="200" autoplay muted 
           style="border:2px solid #ff7e29; border-radius:10px;">
    </video>

    <p id="face-status" style="font-weight:bold; color:#ff7e29;">
        Detecting face...
    </p>
</div>

<!-- ------------------- QUIZ UI ------------------- -->
<div class="quiz-wrapper">
  <div class="quiz-container">

    <!-- Header -->
    <div class="quiz-header">
      <div class="quiz-progress">
        <span id="question-count">1</span> of {{ questions|length }}
      </div>
      <div class="quiz-timer" id="timer">20</div>
    </div>

    <h4 class="quiz-title">{{ quiz.title }}</h4>
    <p class="quiz-subtitle">Question <span id="qNumber">1</span> of {{ questions|length }}</p>

    <!-- FORM -->
    <form method="POST" action="{% url 'submit_quiz' quiz.id %}" id="quiz-form">
      {% csrf_token %}

      {% for q in questions %}
      <div class="question-card {% if not forloop.first %}d-none{% endif %}" 
           id="question-{{ forloop.counter }}">

        <p class="question-text">“{{ q.text }}”</p>

        <div class="options">
          <label class="option"><input type="radio" name="question_{{ q.id }}" value="A"><span>{{ q.option_a }}</span></label>
          <label class="option"><input type="radio" name="question_{{ q.id }}" value="B"><span>{{ q.option_b }}</span></label>
          <label class="option"><input type="radio" name="question_{{ q.id }}" value="C"><span>{{ q.option_c }}</span></label>
          <label class="option"><input type="radio" name="question_{{ q.id }}" value="D"><span>{{ q.option_d }}</span></label>
        </div>

        <div class="button-row">
          {% if not forloop.first %}
          <button type="button" class="btn btn-secondary prev-btn" data-current="{{ forloop.counter }}">
            Previous
          </button>
          {% endif %}

          {% if not forloop.last %}
          <button type="button" class="btn btn-next next-btn" data-current="{{ forloop.counter }}">
            Next
          </button>
          {% else %}
          <button type="submit" class="btn btn-submit">Submit Quiz</button>
          {% endif %}
        </div>

      </div>
      {% endfor %}
    </form>

  </div>
</div>

<!-- ------------------- CSS ------------------- -->
<style>
  body {
    background: linear-gradient(180deg, #5B2EFF, #2E1B80);
    color: white;
    font-family: Poppins, sans-serif;
  }
  .quiz-wrapper { display:flex; justify-content:center; padding:30px; }
  .quiz-container { background:#1D1A39; padding:25px; border-radius:20px; width:100%; max-width:520px; }
  .quiz-header { display:flex; justify-content:space-between; align-items:center; }
  .quiz-progress { background:#ffffff20; padding:6px 15px; border-radius:12px; }
  .quiz-timer { width:50px; height:50px; background:#ff7e29; border-radius:50%; display:flex; justify-content:center; align-items:center; font-weight:bold; }
  .quiz-title { text-align:center; color:#ff7e29; margin-top:15px; }
  .quiz-subtitle { text-align:center; color:#ccc; margin-bottom:20px; }
  .options { display:flex; flex-direction:column; gap:10px; }
  .option { background:#2A2550; padding:12px; border-radius:10px; cursor:pointer; }
  .option:hover { background:#3C3575; }
  .option input { display:none; }
  .button-row { margin-top:20px; display:flex; justify-content:space-between; }
  .btn { padding:10px 20px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
  .btn-next { background:#ff7e29; color:white; }
  .btn-secondary { background:#555; color:white; }
  .btn-submit { background:#00C896; color:white; width:100%; }
</style>

<!-- ------------------- FACE API SCRIPT ------------------- -->
<script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
/* ------------------ FACE DETECTION SYSTEM ------------------ */
const video = document.getElementById("webcam");
const faceStatus = document.getElementById("face-status");
let noFaceCounter = 0;

async function startFaceSystem() {

    // FIXED: Load from Django static folder
    await faceapi.nets.tinyFaceDetector.loadFromUri("{% static 'models' %}");

    // Start camera
    navigator.mediaDevices.getUserMedia({ video:true })
        .then(stream => video.srcObject = stream)
        .catch(() => alert("Camera access required!"));
}

video.addEventListener("play", () => {

    const detect = async () => {

        const detections = await faceapi.detectAllFaces(
            video,
            new faceapi.TinyFaceDetectorOptions()
        );

        if (detections.length > 0) {
            faceStatus.textContent = "Face detected ✔";
            faceStatus.style.color = "#00ff99";
            noFaceCounter = 0;
        } else {
            faceStatus.textContent = "No face detected ❌";
            faceStatus.style.color = "#ff4444";
            noFaceCounter++;

            if (noFaceCounter >= 5) {
                alert("⚠ No face detected for too long! Submitting quiz.");
                document.getElementById("quiz-form").submit();
            }
        }

        setTimeout(detect, 700);
    };

    detect();
});

startFaceSystem();

/* ------------------ TIMER ------------------ */
let seconds = 20;
const timerDisplay = document.getElementById("timer");
const quizForm = document.getElementById("quiz-form");

function startTimer() {
    timerDisplay.textContent = seconds;

    if (seconds > 0) {
        seconds--;
        setTimeout(startTimer, 1000);
    } else {
        alert("⏰ Time's up! Submitting quiz.");
        quizForm.submit();
    }
}
startTimer();

/* ------------------ QUESTION NAVIGATION ------------------ */
let currentQuestion = 1;

document.addEventListener("click", (e) => {

    if (e.target.classList.contains("next-btn")) {
        let curr = parseInt(e.target.dataset.current);
        document.getElementById(`question-${curr}`).classList.add("d-none");
        currentQuestion = curr + 1;

        document.getElementById(`question-${currentQuestion}`).classList.remove("d-none");
        document.getElementById("qNumber").textContent = currentQuestion;
        document.getElementById("question-count").textContent = currentQuestion;
    }

    if (e.target.classList.contains("prev-btn")) {
        let curr = parseInt(e.target.dataset.current);
        document.getElementById(`question-${curr}`).classList.add("d-none");
        currentQuestion = curr - 1;

        document.getElementById(`question-${currentQuestion}`).classList.remove("d-none");
        document.getElementById("qNumber").textContent = currentQuestion;
        document.getElementById("question-count").textContent = currentQuestion;
    }

});
</script>

{% endblock %}
