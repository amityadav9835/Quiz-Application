{% extends "quiz_app/home.html" %}
{% block title %}{{ quiz.title }} - Take Quiz{% endblock %}

{% block content %}
<div class="quiz-bg">
  <div id="x1" class="container mt-4">

    <!-- Quiz Header with Subject and Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold">{{ quiz.title }}</h5>
      <div id="timer-container" class="text-end d-none">
        <span class="fw-bold text-danger" id="timer"></span>
      </div>
    </div>

    <!-- Question Navigation -->
    <div class="d-flex justify-content-center mb-4">
      {% for q in questions %}
        <div class="circle-nav mx-1 {% if forloop.first %}active{% endif %}" id="nav-{{ forloop.counter }}">
          {{ forloop.counter }}
        </div>
      {% endfor %}
    </div>

    <!-- Start Button -->
    <div style="text-align:center;" id="start-container" class="text-center">
      <button class="btn btn-primary btn-lg px-5 py-2" onclick="startQuiz()">Start Quiz</button>
    </div>

    <!-- Quiz Form -->
    <form method="POST" action="{% url 'submit_quiz' quiz.id %}" id="quiz-form" class="d-none">
      {% csrf_token %}
      {% if questions %}
        {% for q in questions %}
          <div class="question-card d-none" id="question-{{ forloop.counter }}">
            <p class="fw-bold fs-5">{{ q.text }}</p>
            <p class="text-muted small">Choose your answer from below</p>

            <div class="list-group mt-3">
              <input type="radio" class="btn-check" name="question_{{ q.id }}" id="q{{ q.id }}A" value="A" required>
              <label class="list-group-item list-group-item-action option-label" for="q{{ q.id }}A">
                <strong>A</strong> {{ q.option_a }}
              </label>

              <input type="radio" class="btn-check" name="question_{{ q.id }}" id="q{{ q.id }}B" value="B">
              <label class="list-group-item list-group-item-action option-label" for="q{{ q.id }}B">
                <strong>B</strong> {{ q.option_b }}
              </label>

              <input type="radio" class="btn-check" name="question_{{ q.id }}" id="q{{ q.id }}C" value="C">
              <label class="list-group-item list-group-item-action option-label" for="q{{ q.id }}C">
                <strong>C</strong> {{ q.option_c }}
              </label>

              <input type="radio" class="btn-check" name="question_{{ q.id }}" id="q{{ q.id }}D" value="D">
              <label class="list-group-item list-group-item-action option-label" for="q{{ q.id }}D">
                <strong>D</strong> {{ q.option_d }}
              </label>
            </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-4">
              {% if not forloop.first %}
                <button type="button" class="btn btn-secondary prev-btn" data-current="{{ forloop.counter }}">Previous</button>
              {% endif %}
              {% if not forloop.last %}
                <button type="button" class="btn btn-primary next-btn ms-auto" data-current="{{ forloop.counter }}">Next</button>
              {% else %}
                <button type="submit" class="btn btn-success ms-auto">Submit Quiz</button>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-center">No questions available for this quiz.</p>
      {% endif %}
    </form>
  </div>
</div>

<!-- Custom Styles -->
<style>
  /* Full page background */
  .quiz-bg {
    min-height: 100vh;
    background: url("https://images.unsplash.com/photo-1606326608690-4e0281b1e588?q=80&w=2070&auto=format&fit=crop") no-repeat center center fixed;
    background-size: cover;
    padding: 2rem;
  }

  .circle-nav {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
  }

  .circle-nav.active {
    background: #ff7e5f;
    color: #fff;
  }

  .option-label {
    border-radius: 10px;
    margin-bottom: 10px;
    font-size: 16px;
    padding: 12px;
  }

  .btn-check:checked + .option-label {
    background-color: #ff7e5f;
    color: #fff;
  }
</style>

<!-- JavaScript -->
<script>
  let seconds = {{ quiz.time_limit|default:10 }} * 60;
  let currentQuestion = 1;
  const totalQuestions = {{ questions|length }};
  const timerDisplay = document.getElementById('timer');
  const quizForm = document.getElementById('quiz-form');

  function startQuiz() {
    document.getElementById('start-container').classList.add('d-none');
    quizForm.classList.remove('d-none');
    document.getElementById('timer-container').classList.remove('d-none');
    document.getElementById(`question-${currentQuestion}`).classList.remove('d-none');
    updateNav();
    updateTimer();
  }

  function updateTimer() {
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    timerDisplay.textContent = `${min}:${sec.toString().padStart(2, '0')}`;
    if (seconds > 0) {
      seconds--;
      setTimeout(updateTimer, 1000);
    } else {
      alert("Time is up! Submitting your quiz.");
      quizForm.submit();
    }
  }

  function updateNav() {
    document.querySelectorAll(".circle-nav").forEach((el, idx) => {
      el.classList.remove("active");
      if (idx + 1 === currentQuestion) {
        el.classList.add("active");
      }
    });
  }

  document.addEventListener("click", function(e) {
    if (e.target.classList.contains("next-btn")) {
      let curr = parseInt(e.target.dataset.current);
      document.getElementById(`question-${curr}`).classList.add("d-none");
      currentQuestion = curr + 1;
      document.getElementById(`question-${currentQuestion}`).classList.remove("d-none");
      updateNav();
    }
    if (e.target.classList.contains("prev-btn")) {
      let curr = parseInt(e.target.dataset.current);
      document.getElementById(`question-${curr}`).classList.add("d-none");
      currentQuestion = curr - 1;
      document.getElementById(`question-${currentQuestion}`).classList.remove("d-none");
      updateNav();
    }
  });
</script>
{% endblock %}
